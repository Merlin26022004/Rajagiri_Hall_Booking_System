{% extends "base.html" %}

{% block content %}
<div class="container py-4">
    <h2 class="section-title mb-3">Book a Space</h2>

    <form method="post" class="space-card p-4">
        {% csrf_token %}

        <div class="mb-3">
            <label class="form-label fw-semibold">Select Space</label>
            <select name="space_id" id="spaceSelect" class="form-select" required>
                <option value="">-- Choose Space --</option>
                {% for space in spaces %}
                <option value="{{ space.id }}"
                    {% if selected_space and selected_space.id == space.id %}selected{% endif %}>
                    {{ space.name }} ({{ space.get_type_display }})
                </option>
                {% endfor %}
            </select>
        </div>

        <div class="mb-3">
            <label class="form-label fw-semibold">Date</label>
            <input type="date" name="date" id="dateInput" class="form-control" required>
            <small class="text-muted d-block mt-1">
                Same-day bookings allowed if time does not overlap.
            </small>
        </div>

        <div id="existingSlots" class="alert alert-info d-none"></div>

        <div class="row">
            <div class="col-md-6 mb-3">
                <label class="form-label fw-semibold">Start Time</label>
                <input type="time" name="start_time" class="form-control" required>
            </div>
            <div class="col-md-6 mb-3">
                <label class="form-label fw-semibold">End Time</label>
                <input type="time" name="end_time" class="form-control" required>
            </div>
        </div>

        <div class="mb-3">
            <label class="form-label fw-semibold">Expected Count</label>
            <input type="number" name="expected_count" class="form-control" required>
        </div>

        <div class="mb-3">
            <label class="form-label fw-semibold">Purpose</label>
            <textarea name="purpose" rows="2" class="form-control" required></textarea>
        </div>

        <div class="mb-4">
            <label class="form-label fw-semibold d-block">Available Facilities</label>
            <div class="card bg-light border-0">
                <div class="card-body p-3">
                    <div id="facilitiesContainer" class="row">
                        <p class="text-muted small mb-0 fst-italic">Select a space to see available equipment.</p>
                    </div>
                </div>
            </div>
        </div>

        {% if not user.is_staff %}
        <div class="mb-4 p-3 bg-light rounded border border-warning">
            <label for="faculty_in_charge" class="form-label fw-semibold text-dark">
                Faculty In-Charge (Required)
            </label>
            <input type="text" 
                   name="faculty_in_charge" 
                   id="faculty_in_charge" 
                   class="form-control" 
                   placeholder="Enter name of the Professor who approved this" 
                   required>
            <small class="text-muted d-block mt-1">
                Since you are a student, you must specify which faculty member gave you permission.
            </small>
        </div>
        {% endif %}

        <button class="btn btn-book px-4">Submit</button>
    </form>
</div>

<script>
document.getElementById("dateInput").addEventListener("change", loadSlots);
document.getElementById("spaceSelect").addEventListener("change", function() {
    loadSlots();
    loadFacilities(); // <--- Trigger the new function
});

// 1. Load Time Slots (Existing Logic)
function loadSlots(){
    const space = document.getElementById("spaceSelect").value;
    const date = document.getElementById("dateInput").value;
    const box = document.getElementById("existingSlots");
    
    if(!space || !date) {
        box.classList.add("d-none");
        return;
    }

    fetch(`/api/space-day-slots/?space_id=${space}&date=${date}`)
    .then(r => r.json())
    .then(data => {
        if(data.length === 0){
            box.classList.add("d-none");
            return;
        }

        box.classList.remove("d-none");
        box.innerHTML = "<b>Already booked time slots:</b><br>" +
            data.map(t => `❌ ${t.start} – ${t.end}`).join("<br>");
    });
}

// 2. Load Facilities (NEW Logic)
function loadFacilities() {
    const spaceId = document.getElementById("spaceSelect").value;
    const container = document.getElementById("facilitiesContainer");

    if (!spaceId) {
        container.innerHTML = '<p class="text-muted small mb-0 fst-italic">Select a space to see available equipment.</p>';
        return;
    }

    // Fetch facilities specific to this space
    fetch(`/api/space-facilities/?space_id=${spaceId}`)
    .then(response => response.json())
    .then(data => {
        if (data.length === 0) {
            container.innerHTML = '<p class="text-muted small mb-0">No specific facilities listed for this hall.</p>';
            return;
        }

        // Build Checkboxes dynamically
        let html = "";
        data.forEach(fac => {
            html += `
            <div class="col-md-4 col-sm-6 mb-2">
                <div class="form-check">
                    <input class="form-check-input" type="checkbox" 
                           name="facilities" 
                           value="${fac.id}" 
                           id="fac_${fac.id}">
                    <label class="form-check-label" for="fac_${fac.id}">
                        ${fac.name}
                    </label>
                </div>
            </div>`;
        });
        container.innerHTML = html;
    })
    .catch(err => console.error("Error loading facilities:", err));
}
</script>

{% endblock %}